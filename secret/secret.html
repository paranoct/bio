<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Секрет — загадка</title>
  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    /* Базовые стили взяты из main — упрощённая версия для страницы-головоломки */
    :root{ --bg-black:#000; --deep-blue:#4a8ba3; --deep-blue-strong:#a9e6f7; --soft-blue:#3f7486 }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg-black);color:var(--deep-blue-strong);font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;overflow:hidden}

    .page-bg{position:fixed;inset:0;z-index:-2;pointer-events:none;background-image:url('fon.jpg');background-size:cover;background-position:center center;opacity:0.3;filter:brightness(0.7) saturate(0.95)}
    .lamp{position:fixed;right:80%;top:95%;width:520px;height:520px;z-index:0;pointer-events:none;background-image:url('1');background-size:contain;background-repeat:no-repeat;background-position:50% 100%;opacity:0.27}
    .lamp::after{content:'';position:absolute;left:40%;top:15%;width:550px;height:550px;transform:translate(-50%,-50%) scale(1);border-radius:50%;background:radial-gradient(circle at 50% 30%, rgba(255,230,170,0.9) 0%, rgba(255,200,100,0.5) 20%, rgba(255,160,50,0.18) 36%, rgba(0,0,0,0) 62%);filter:blur(12px) contrast(1.04);z-index:1;pointer-events:none;opacity:0.95;transition:transform 160ms ease, opacity 160ms ease, filter 160ms ease}
    .lamp.flicker::after{ transform:translate(-50%,-50%) scale(0.96); opacity:0.72; filter:blur(8px) contrast(1.08) brightness(1.03); }
    .lamp.dim::after{ transform:translate(-50%,-50%) scale(0.82); opacity:0.28; filter:blur(22px) contrast(0.9) brightness(0.62); }
    .lamp.spark::after{ transform:translate(-50%,-50%) scale(1.12); opacity:1.12; filter:blur(6px) contrast(1.18) brightness(1.15); }

    canvas#snowCanvas{position:fixed;inset:0;z-index:2}

    .center{position:relative;z-index:6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px}
    .box{width:100%;max-width:720px;border-radius:12px;padding:18px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 60px rgba(0,0,0,0.7);backdrop-filter:blur(12px);text-align:center}
    h1{margin:0 0 10px 0;font-weight:800;color:var(--deep-blue-strong)}
    p.lead{margin:0 0 18px 0;color:rgba(207,230,247,0.85)}

    .input-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
    input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--deep-blue-strong);min-width:320px}
    button{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(180deg,#4a8ba3,#3f7486);color:#021;font-weight:700;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease,opacity .12s ease;}
button:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.45);opacity:0.98}
button:active{transform:translateY(-1px) scale(0.99)}
button:focus{outline:2px solid rgba(74,139,163,0.12);outline-offset:3px}

button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--deep-blue-strong);transition:transform .12s ease,box-shadow .12s ease,opacity .12s ease}
button.ghost:hover{transform:translateY(-4px);background:rgba(255,255,255,0.015);box-shadow:0 8px 20px rgba(0,0,0,0.35)}
button.ghost:active{transform:translateY(-1px) scale(0.99)}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--deep-blue-strong)}

    #result{margin-top:14px;min-height:28px;font-weight:700;color:#dfefff}

    /* анимация размера коробки: расширяем, когда есть результат */
    .box{ transition: max-height .28s ease, padding .18s ease, transform .18s ease; overflow:hidden; max-height:420px }
    .box.has-result{ max-height:880px; padding:22px; transform:translateY(-4px) }
    
    #next{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:none}

    @media (max-width:600px){ input[type=text]{min-width:160px} .lamp,.page-bg{display:none} canvas#snowCanvas{display:none} }
  </style>
</head>
<body>
  <div class="page-bg" aria-hidden="true"></div>
  <div class="lamp" id="lampBg" aria-hidden="true"></div>
  <canvas id="snowCanvas" aria-hidden="true"></canvas>

  <div class="center">
    <div class="box" role="main">
      <h1>Тайная загадка</h1>
      <p class="lead">В этой комнате хранится простая проверка: cookie закодирована в Base64. Введите код и нажмите "Установить" — затем "Проверить". Если decoded cookie совпадёт с секретным словом, откроется следующая подсказка.</p>

      <div class="input-row">
        <input id="userInput" type="text" placeholder="Введите код (plaintext)" aria-label="Поле ввода" />
        <button id="setBtn">Установить cookie</button>
        <button id="checkBtn" class="ghost">Проверить</button>
      </div>

      <div id="result" role="status" aria-live="polite"></div>

      <div id="next">Поздравляем — вы прошли проверку!<br>Секрет: <code id="secretReveal">—</code></div>
    </div>
  </div>

  <script>
    setCookie("second_part", "ran0ct_s3", 7);
    (function lampFlicker(){
      const lamp = document.getElementById('lampBg');
      function trigger(){
        const r = Math.random();
        if(r < 0.06){ lamp.classList.add('dim'); setTimeout(()=> lamp.classList.remove('dim'), 300 + Math.random()*900); }
        else if(r < 0.34){ lamp.classList.add('flicker'); setTimeout(()=> lamp.classList.remove('flicker'), 80 + Math.random()*180); }
        else if(r > 0.986){ lamp.classList.add('spark'); setTimeout(()=> lamp.classList.remove('spark'), 90 + Math.random()*220); }
        setTimeout(trigger, 200 + Math.random()*1000);
      }
      trigger();
    })();
    (function(){
      const canvas = document.getElementById('snowCanvas');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      let w = canvas.width = innerWidth; let h = canvas.height = innerHeight;
      let densityMultiplier = 10.0; let flakes = []; let snowEnabled = true; let globalAlphaMultiplier = 0.9/0.03;
      function rand(a,b){return Math.random()*(b-a)+a}
      function generateFlakes(){ const base = Math.floor((w*h)/38000); const COUNT = Math.max(6, Math.floor(base * densityMultiplier)); flakes.length=0; for(let i=0;i<COUNT;i++) flakes.push({x:Math.random()*w,y:Math.random()*h,r:rand(0.6,2.2),speed:rand(0.2,0.9),baseAlpha:rand(0.005,0.03)}); }
      generateFlakes(); addEventListener('resize', ()=>{w=canvas.width=innerWidth;h=canvas.height=innerHeight;generateFlakes()});
      function draw(){ ctx.clearRect(0,0,w,h); if(!snowEnabled){ requestAnimationFrame(draw); return } for(let i=0;i<flakes.length;i++){const f=flakes[i];ctx.beginPath();const alpha=Math.max(0,Math.min(1,f.baseAlpha*globalAlphaMultiplier));ctx.fillStyle='rgba(255,255,255,'+alpha+')';ctx.arc(f.x,f.y,f.r,0,Math.PI*2);ctx.fill();f.y+=f.speed;f.x+=Math.sin(f.y*0.01+i)*0.4;if(f.y>h+6){f.y=-10;f.x=Math.random()*w}}requestAnimationFrame(draw)}
      draw();
    })();
    const COOKIE_NAME = 'secret_puzzle';
    function b64EncodeUnicode(str){ return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1){return String.fromCharCode('0x'+p1);})); }
    function b64DecodeUnicode(str){ try{ return decodeURIComponent(Array.prototype.map.call(atob(str), function(c){ return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join('')); }catch(e){ return null; } }
    function setCookie(name, value, days){ const d = new Date(); d.setTime(d.getTime() + (days||7)*24*60*60*1000); document.cookie = name + '=' + encodeURIComponent(value) + ';path=/;expires=' + d.toUTCString() + ';SameSite=Lax'; }
    function getCookie(name){ const pairs = document.cookie.split(';').map(s=>s.trim()); for(const p of pairs){ if(!p) continue; const idx = p.indexOf('='); const k = p.substring(0,idx); const v = p.substring(idx+1); if(k===name) return decodeURIComponent(v); } return null; }
    const input = document.getElementById('userInput'); const setBtn = document.getElementById('setBtn'); const checkBtn = document.getElementById('checkBtn'); const result = document.getElementById('result'); const next = document.getElementById('next'); const secretReveal = document.getElementById('secretReveal');
    function setBoxExpanded(expanded){
      const boxEl = document.querySelector('.box');
      if(!boxEl) return;
      if(expanded) boxEl.classList.add('has-result');
      else boxEl.classList.remove('has-result');
    }
    function show(text, ok){
      result.textContent = text;
      result.style.color = ok ? '#9cffb2' : '#ffb2b2';
      setBoxExpanded(Boolean(text && String(text).trim()));
    }
    //first part of flag is bio{p4
    document.addEventListener('click', (e)=>{
      try{
        if(e.target && e.target.tagName === 'BUTTON'){
          setTimeout(()=>{
            setBoxExpanded(Boolean(result.textContent && String(result.textContent).trim()) || (next && next.style.display === 'block'));
          }, 120);
        }
      }catch(e){ }
    });
    const SECRET = 'bio{p4ran0ct_s3cre+_e45y}';
    setTimeout(()=>{ setBoxExpanded(Boolean(result.textContent && String(result.textContent).trim()) || (next && next.style.display === 'block')); }, 50);
    setBtn.addEventListener('click', ()=>{
      const val = input.value || '';
      const encoded = b64EncodeUnicode(val);
      setCookie(COOKIE_NAME, encoded, 7);
      show('Cookie установлен (base64): ' + encoded, true);
    });
    checkBtn.addEventListener('click', ()=>{
      const c = getCookie(COOKIE_NAME);
      if(!c){ show('Cookie не найден — сначала установите его', false); return; }
      const decoded = b64DecodeUnicode(c);
      if(decoded === null){ show('Cookie не является корректным base64', false); return; }
      if(decoded === SECRET){ show('Успех — секрет совпал!', true); secretReveal.textContent = SECRET; next.style.display = 'block';
      } else { show('Неверно — попробуйте снова', false); }
    });
    (function tryUrlSet(){ try{ const params = new URLSearchParams(location.search); if(params.has('set')){ const v = params.get('set')||''; input.value = v; const enc = b64EncodeUnicode(v); setCookie(COOKIE_NAME, enc, 7); show('Установлено из URL (base64): ' + enc, true); } }catch(e){} })();

  </script>
</body>
</html>
